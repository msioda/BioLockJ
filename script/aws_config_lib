#!/bin/bash
##############################################################
##                                                          ##
##  This script is used for AWS Config functions            ##
##                                                          ##
##############################################################
. $BLJ/script/blj_functions

aws_cred_file=~/.aws/credentials
blj_aws_config=~/.aws/blj_config
sheBang='#!/bin/bash'
IS_NULL="IS_NULL"
DB="/db"

# Archive previous AWS Config properties file: $blj_aws_config
aws_archive() {
	aws_history=~/.aws/history
	[ ! -d $aws_history ] && mkdir $aws_history
	[ -f $blj_aws_config ] && mv $blj_aws_config $aws_history/blj_config-$(date "+%Y-%m-%d.%H.%M.%S")
	echo $sheBang > $blj_aws_config
	chmod 770 $blj_aws_config
}

# Get an AWS property $1 from local AWS Config file $2 under the awsProfile
# Param 1 argName Parse filePath for a line that starts with argName
# Param 2 filePath Target file
aws_local_prop() {
	[ ! -f "$2" ] && aws_log "Error:  File not found: $2" && return
	foundProfile=0
	prop="$1 = "
	userProfile="[$(get_blj_prop awsProfile)]"
	cat $2 | while read -r line; do
		[ $foundProfile -eq 1 ] && [ "${line:0:1}" == "[" ] && break
		[ $foundProfile -eq 1 ] && [ "${line:0:${#prop}}" == "$prop" ] && echo "${line/$prop}" && return
		[ "$line" == "$userProfile" ] && foundProfile=1
	done
}

# Log current time-stamp and print the line parameter
# Param 1 - Log statement  
aws_log() {
	echo "[ $(date "+%Y-%m-%d %H:%M:%S") ] $1"
}

# Get the s3 bucket names in the user region
aws_s3_buckets() {
	myBuckets=$(aws s3api list-buckets --region $(get_blj_prop awsRegion) --query "Buckets[].Name")
	[ ${#myBuckets} -eq 0 ] || [ "$myBuckets" == "None" ] && return
	echo "${myBuckets}"
}

# Lists stacks available on AWS. If status arg provided, only return stacks with the given status.
# Param 1 (optional) Stack status
aws_stacks() {
	awsStacks=
	if [ $# -eq 1 ]; then
		awsStacks=$(aws cloudformation describe-stacks --query "Stacks[?StackStatus=='$1'].StackName")
		[ ${#awsStacks} -eq 0 ] || [ "${awsStacks}" == "None" ] && return
	else
		awsStacks=$(aws cloudformation describe-stacks --query "Stacks[].StackName")
		[ ${#awsStacks} -eq 0 ] || [ "${awsStacks}" == "None" ] && return
	fi
	echo "${awsStacks}"
}

# Get a prop stored in $blj_aws_config
# Param 1 Prop name
# Param 2 (optional) Default value
get_blj_prop() {
	val=$(get_prop $blj_aws_config $1)
	[ ${#val} -eq 0 ] && val=$2
	[ ${#val} -gt 0 ] && response=$(set_blj_prop $1 $val)
	echo "${val}"
}

# Return property value from the given file
# Param 1 - Config file
# Param 2 - Prop name
get_prop() {
	prop=$(cat $1 | grep $2)
	out=$(eval "echo ${prop/$2=}")
	echo "${out}"
}


# Get a stack parameter for the configured stack 
# Param 1 - Param name
get_stack_param() {
	myParam=$(aws cloudformation describe-stacks --stack-name $(get_blj_prop awsStack) --query "Stacks[*].Outputs[?OutputKey=='$1'].OutputValue")
	[ ${#myParam} -eq 0 ] && return
	echo "${myParam}"
}

# Init AWS Config properties file [ $blj_aws_config ] with pipeline Config, AWS config, and standard defaults
# Check BLJ pipeline Config files + all nested default Config files
# Param 1 Pipeline Config file path
init_aws_config() {
	aws_archive
	aws_log "Copy AWS properties from Pipeline Config [ $1 ] into --> AWS Config [ $blj_aws_config ]"
	set_pipeline_config_files $1
	configFiles=$(get_blj_prop configFiles)
	IFS2=$IFS && IFS="," && propFiles=( $configFiles ) && IFS=$IFS2
	for propFile in ${propFiles[@]}; do
		set_pipeline_conig_props $propFile
	done
	verify_required_config
	aws_log "Pipeline Config properties initialized stored with AWS Config properties in: $blj_aws_config"
	aws_report_config
}

# Get the ec2 key file for the ec2 head node
key_file() {
	echo ~/.aws/$(get_blj_prop awsStack)-KeyPair.pem
}

# Remove AWS property - delete the line from the file
# Param 1 - prop name 
rm_blj_prop() {
	conf=$(cat $blj_aws_config)
	[ ${#conf} -eq 0 ] && return
	TMP=~/.temp.txt
	[ -f $TMP ] && rm $TMP
	echo $sheBang > $TMP
	chmod 770 $TMP
	cat $blj_aws_config | while read -r line; do
		if [ "${line:0:1}" != "#" ]; then
			IFS2=$IFS && IFS="=" && tokens=( ${line} )
			IFS=$IFS2 && [ "${tokens[0]}" != "$1" ] && echo ${line} >> $TMP
		fi
	done
	rm $blj_aws_config
	[ -f $TMP ] && mv $TMP $blj_aws_config
}

# Set a prop stored in $blj_aws_config.  In case prop value ${2} is null, $2 actually returns the 3rd param (the default)
# If the default value = $IS_NULL return without making any updates
# Param 1 Prop name
# Param 2 Prop value
# Param 3 (optional) Default value
set_blj_prop() {
	[ $# -lt 2 ] || [ "$2" == $IS_NULL ] && return
	prop=$(cat $blj_aws_config | grep $1)
	exists=$(echo $prop | grep "$1=${2/\[/\\\[}")
	[ ${#exists} -gt 0 ] && return
	rm_blj_prop $1
	echo "$1=$2" >> $blj_aws_config
}

# Set property "configFiles" as list of project Config files + nested default Config files.
# Files should be listed in order from standard.props up to project.props
# Param 1 Pipeline Config file-path
set_pipeline_config_files() {
	aws_log "Search pipeline Config [ $1 ] for nested Config files defined by: \"pipeline.defaultProps\""
	configFiles=$1
	propFile=$(get_prop $1 "pipeline.defaultProps")
	while [ -f "$propFile" ]; do
		configFiles="$propFile,$configFiles"
		propFile=$(get_prop $propFile "pipeline.defaultProps")
	done
	aws_log "Save list of pipeline Config files configFiles=$configFiles"
	set_blj_prop configFiles $configFiles
}

# Save AWS Config properties from pipeline Config file to AWS Config file: $blj_aws_config
# Param 1 Pipeline Config file path
set_pipeline_conig_props() {
	aws_log "Update [ $blj_aws_config ] with any AWS properties found in Pipeline Config [ $1 ]"
	set_blj_prop awsAccountId $(get_prop $1 "aws.account_id") $IS_NULL
	set_blj_prop awsEc2AcquisitionStrategy $(get_prop $1 "aws.ec2AcquisitionStrategy") $IS_NULL
	set_blj_prop awsEc2InstanceType $(get_prop $1 "aws.ec2InstanceType") $IS_NULL
	set_blj_prop awsEc2SpotPer $(get_prop $1 "aws.ec2SpotPer") $IS_NULL
	set_blj_prop awsProfile $(get_prop $1 "aws.profile") $IS_NULL
	set_blj_prop awsRam $(get_prop $1 "aws.ram") $IS_NULL
	set_blj_prop awsRegion $(get_prop $1 "aws.region") $IS_NULL
	set_blj_prop awsStack $(get_prop $1 "aws.stack") $IS_NULL
	set_blj_prop awsS3 $(get_prop $1 "aws.s3") $IS_NULL
	set_blj_prop awsWalltime $(get_prop $1 "aws.walltime") $IS_NULL
	set_blj_prop dockerImgVersion $(get_prop $1 "docker.imgVersion") $IS_NULL
	set_blj_prop dockerUser $(get_prop $1 "docker.user") $IS_NULL
	set_blj_prop humann2NuclDB $(get_prop $1 "humann2.nuclDB") $IS_NULL
	set_blj_prop humann2ProtDB $(get_prop $1 "humann2.protDB") $IS_NULL
	set_blj_prop inputDirPath $(get_prop $1 "input.dirPaths") $IS_NULL
	set_blj_prop kneaddataDbs $(get_prop $1 "kneaddata.dbs") $IS_NULL
	set_blj_prop krakenDb $(get_prop $1 "kraken.db") $IS_NULL
	set_blj_prop kraken2Db $(get_prop $1 "kraken2.db") $IS_NULL
	set_blj_prop metadataFilePath $(get_prop $1 "metadata.filePath") $IS_NULL
	set_blj_prop metaphlan2Db $(get_prop $1 "metaphlan2.db") $IS_NULL
	set_blj_prop metaphlan2Mpa_pkl $(get_prop $1 "metaphlan2.mpa_pkl") $IS_NULL
	set_blj_prop qiimePynastAlignDB $(get_prop $1 "qiime.pynastAlignDB") $IS_NULL
	set_blj_prop qiimeRefSeqDB $(get_prop $1 "qiime.refSeqDB") $IS_NULL
	set_blj_prop qiimeTaxaDB $(get_prop $1 "qiime.taxaDB") $IS_NULL
	set_blj_prop rdpDb $(get_prop $1 "rdp.db") $IS_NULL
	set_blj_prop trimPrimersFilePath $(get_prop $1 "trimPrimers.filePath") $IS_NULL
	aws_report_config
}

# Set basic defaults if undefined & throw error if user did not login to aws client or is missing required properties
verify_required_config() {
	aws_log "Assign default Config properties..."
	. $blj_aws_config
	[ ${#awsAccountId} -eq 0 ] && set_blj_prop awsAccountId $(aws ec2 describe-security-groups --group-names Default --query SecurityGroups[0].OwnerId)
	[ ${#awsProfile} -eq 0 ] && set_blj_prop awsProfile default
	[ ${#awsRegion} -eq 0 ] && set_blj_prop awsRegion $(aws configure get region)
	[ ${#awsEc2InstanceType} -eq 0 ] && set_blj_prop awsEc2InstanceType t2.micro
	[ ${#dockerImgVersion} -eq 0 ] && set_blj_prop dockerImgVersion latest
	[ ${#dockerUser} -eq 0 ] && set_blj_prop dockerUser biolockj
	[ ${#humann2NuclDB} -eq 0 ] && set_blj_prop "$DB/chocophlan"
	[ ${#humann2ProtDB} -eq 0 ] && set_blj_prop "$DB/uniref"
	[ ${#kneaddataDbs} -eq 0 ] && set_blj_prop kneaddataDbs $DB
	[ ${#krakenDb} -eq 0 ] && set_blj_prop krakenDb $DB
	[ ${#kraken2Db} -eq 0 ] && set_blj_prop kraken2Db  $DB
	
	set_blj_prop aws_access_key_id $(aws_local_prop aws_access_key_id $aws_cred_file)
	set_blj_prop aws_secret_access_key $(aws_local_prop aws_secret_access_key $aws_cred_file)
	. $blj_aws_config
	aws_log "Verify aws client authentication..."
	[ ${#awsAccountId} -eq 0 ] && exit_script "Error [ aws_config_lib ]: Unable to find AWS Config \"aws.account_id\" - please log into aws client from command line and try again."
	[ ${#awsRegion} -eq 0 ] && exit_script "Error [ aws_config_lib ]: Unable to find AWS Config \"aws.region\" in ~/.aws/config - please log into aws client from command line and try again."
	[ ${#aws_access_key_id} -eq 0 ] && exit_script "Error [ aws_config_lib ]: Unable to find AWS Config \"aws_access_key_id\" in ~/.aws/credentials - please log into aws client from command line and try again."
	[ ${#aws_secret_access_key} -eq 0 ] && exit_script "Error [ aws_config_lib ]: Unable to find AWS Config \"aws_secret_access_key\" in ~/.aws/credentials - please log into aws client from command line and try again."
	
	aws_log "Verify required Pipeline Config properties exist ( TO-DO --> implement value or type validations )..."
	[ ${#awsEc2AcquisitionStrategy} -eq 0 ] && exit_script "Error [ aws_config_lib ]: Required Pipeline Config property \"aws.ec2AcquisitionStrategy\" undefined!"
	[ ${#awsEc2SpotPer} -eq 0 ] && exit_script "Error [ aws_config_lib ]: Required Pipeline Config property \"aws.ec2SpotPer\" undefined!"
	[ ${#awsRam} -eq 0 ] && exit_script "Error [ aws_config_lib ]: Required Pipeline Config property \"aws.ram\" undefined!"
}

# Build stack config using awsStack and awsAccountId references and build the roles
#set_stack_config() {
	#awsStack=$(get_blj_prop awsStack)
	#awsAccountId=$(get_blj_prop awsAccountId)
	# NEVER ACTUALLY USED THESE 3
	#set_blj_prop queueName $awsStack-Queue
	#set_blj_prop lowPriorityJobQRole $(get_stack_param JobQueueLowPriority)
	#set_blj_prop efsID $(get_stack_param FileSystemId)  
	# NO REASON TO STORE THESE, can call get_stack_param whenever these are needed
	#set_blj_prop keyName $awsStack-KeyPair
	#set_blj_prop serviceRole $(get_stack_param BatchServiceRoleArn)
	#set_blj_prop iamFleetRole "arn:aws:iam::$awsAccountId:role/$(get_stack_param SpotIamFleetRoleArn)"
	#set_blj_prop jobRoleArn $(get_stack_param ECSTaskRole)
	#set_blj_prop instanceRole "arn:aws:iam::$awsAccountId:instance-profile/$(get_stack_param IamInstanceProfileArn)"
	#set_blj_prop bastionGroup $(get_stack_param BastionSecurityGroup)
	#set_blj_prop subnets "$(get_stack_param Subnet1),$(get_stack_param Subnet2)"
	#set_blj_prop headNodeLaunchTemplate $(get_stack_param HeadNodeLaunchTemplateId)
	#set_blj_prop batchNodeLaunchTemplate $(get_stack_param BatchNodeLaunchTemplateId)
#}
