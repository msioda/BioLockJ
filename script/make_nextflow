#!/bin/bash
################################################################################
##                                                                            ##
##  Build Nexflow main.nf template                                            ##
##  Query for SEARCH_KEY in all java files under $BLJ/src/biolockj/module     ##
##  For each valid file, trim the file path & file extension                  ##
##  Remaining value = Java class name module.getClass().getName() after       ##
##                    substituting "_" for all "." characters                 ##
##                                                                            ##
################################################################################
. $BLJ/script/blj_functions
. /config/aws_config

AWS_DIR="$HOME/.aws"
[ ! -d "$AWS_DIR" ] && mkdir "$AWS_DIR" && echo Created "$AWS_DIR directory"

buildAwsConfig() {
	AWS_CONF="$AWS_DIR/config"
	echo "Generating aws_manager container $AWS_CONF"
	echo "[default]" > $AWS_CONF"
	echo "region = ${awsRegion}" >> $AWS_CONF"
	echo "output = text" >> $AWS_CONF"
	echo "Created --> $AWS_CONF"
	cat $AWS_CONF
}

buildAwsCredentials() {
	AWS_CRED="$AWS_DIR/credentials"
	echo "Generating aws_manager container $AWS_CRED"
	echo "[default]" > $AWS_CRED"
	echo "aws_access_key_id = ${aws_access_key_id}" >> $AWS_CRED"
	echo "aws_secret_access_key = ${aws_secret_access_key}" >> $AWS_CRED"
	echo "Created --> $AWS_CRED"
	cat $AWS_CRED
}

buildNexflowConfigDir() {
	NF_DIR="$HOME/.nextflow"
	[ ! -d "$NF_DIR" ] && mkdir "$NF_DIR" && echo Created "$NF_DIR directory"
	echo "Copy /config/nextflow/${awsStack}/config to --> $NF_DIR"
	cp /config/nextflow/${awsStack}/config $NF_DIR
	echo "Created --> Nextflow config: $NF_DIR/config"
	cat $NF_DIR/config
}

buildNexflowTemplate() {
	modules=$(get_modules)
	numModules=$(echo $modules | wc -w | xargs)
	summaryMsg="BioLockJ $(get_version) generated Nextflow Template \"$MAIN_NF\" with $numModules BioModule process definitions"
	echo "// $summaryMsg" > $MAIN_NF
	echo "" >> $MAIN_NF
	for module in ${modules[@]}; do
		echo "process ${module} {" >> $MAIN_NF
		echo '    echo true' >> $MAIN_NF
		echo '    cpus $script.numThreads' >> $MAIN_NF
		echo '    memory $aws.ram' >> $MAIN_NF
		echo '    label $nextflow.dockerImage' >> $MAIN_NF
		echo '    input:' >> $MAIN_NF
		echo '    val worker from Channel.watchPath( "BLJ_MODULE_SUB_DIR/*.sh" )' >> $MAIN_NF
		echo '    """' >> $MAIN_NF
		echo '    #!/bin/bash' >> $MAIN_NF
		echo '    bash ${worker}' >> $MAIN_NF
		echo '    """' >> $MAIN_NF
		echo '}' >> $MAIN_NF
	done
	echo "-----------------------------------------------------------------------------------------"
	[ -f $MAIN_NF ] && echo "Success!  $summaryMsg" && echo "Deployed: $MAIN_NF"  
	# cat $MAIN_NF
	echo "-----------------------------------------------------------------------------------------"	
}

get_modules() {
	modules=${2//./ }
	modules=( $modules )
	echo ${modules[*]}
}

if [ $# -lt 2 ]; then
	echo "Missing required parameters, 2 params requried main.nf - 1) file-path, 2) List of modules formatted with specific delimiters"
else
	MAIN_NF="${1}"
	buildNexflowConfigDir
	buildAwsConfig
	buildAwsCredentials
	buildNexflowTemplate
fi
