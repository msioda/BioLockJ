#!/bin/bash
###############################################################################
##                                                                           ##
##  This script manually resets current module and pipeline status.          ##
##  All modules numbered higher than the current module will also be reset.  ##
##                                                                           ##
###############################################################################
. $BLJ/script/blj_functions

parentDir="$(dirname $PWD)"
currentDirName="$(basename $PWD)"
maxNum=${currentDirName%_*}

modStarted=$PWD/biolockjStarted
modComplete=$PWD/biolockjComplete
pipelineComplete=$parentDir/biolockjComplete

if [ ${#maxNum} -ne 0 ] && $(valid_file $modComplete ); then

	echo "Reset BioLockJ pipeline $parentDir from step # $maxNum"
	$(valid_file $pipelineComplete) && rm $pipelineComplete && echo "deleted $pipelineComplete"
	$(valid_file $modStarted) && touch $modStarted && echo "created $modStarted"
	rm $modComplete && echo "delete $modComplete"
	
	for pipelineDir in $parentDir/*; do
		if $(valid_dir $pipelineDir); then
			modStarted=$pipelineDir/biolockjStarted
			modComplete=$pipelineDir/biolockjComplete
			dir="$(basename $pipelineDir)"
			modNum=${dir%_*}
			if [ ${#modNum} -gt 0 ] && [ $modNum -gt $maxNum ]; then
				$(valid_file $modComplete) && rm $modComplete && echo "delete $modComplete"
				$(valid_file $modStarted) && touch $modStarted && echo "create $modStarted"
			fi
		fi
	done
	
else
	echo "Command (blj_reset) aborted: no completed pipelines were found." 
fi
