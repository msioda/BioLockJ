#!/bin/bash
##########################################################################
##                                                                      ##
##  Script requires valid BioLockJ Config file passed as a parameter.   ##
##  Script requires valid BioLockJ pipeline root directory: $BLJ_PROJ.  ##
##                                                                      ##
##  Pass optional param "-r" as 1st param to restart failed pipeline    ##
##                                                                      ##
##  Pass admin email password as 1st param to encode and store in the   ##
##  BioLockJ Config file (2nd param) instead of running a pipeline      ##
##                                                                      ##
##########################################################################
. $BLJ/script/blj_functions

config=""
params=""
bljJar=$BLJ/dist/BioLockJ.jar
restart=false

[ ! -d "$BLJ_PROJ" ] && echo "Exit program - Required env variable BLJ_PROJ undefined" && exit 1
[ ! -f "$bljJar" ] && echo "Exit program - $bljJar not found" && exit 1

if [ $# -eq 1 ] && [ "$1" == "-h" ] || [ "$1" == "--help" ]; then   
    echo "BioLockJ $(get_version) - UNCC Fodor Lab July 2018"
    echo "Run new pipeline:                     biolockj <file>"
    echo "Run new pipeline:                     biolockj -c/--config <file>"
    echo "Restart failed pipeline:              biolockj -r/--restart <directory/file>"
    echo "Encrypt email password:               biolockj -p/--password <new_password> <file>"
    echo "View BioLockJ help menu:              biolockj -h/--help"
    exit 0
elif [ $# -eq 1 ]; then
	config=$1
fi

if [ $# -eq 0 ]; then
	echo "Exit program - Invalid parameters: $@" && $BLJ/script/biolockj -h && exit 1
elif [ $# -eq 1 ]; then
	config=$1
elif [ $# -eq 2 ]; then
	if [ "$1" == "-c" ] || [ "$1" == "--config" ]; then
		config=$2
	elif [ "$1" == "-r" ] || [ "$1" == "--restart" ]; then
		echo "Restart pipeline..."
		restart=true
		params=$1
		config=$2
	else
		echo "Exit program - Invalid parameters: $@" && $BLJ/script/biolockj -h && exit 1
	fi
elif [ $# -eq 3 ]; then
	if [ "$1" == "-p" ] || [ "$1" == "--password" ]; then
		echo "Encrypt & save email password to Config property mail.encryptedPassword in $3"
		params="$1 $2"   
		config=$3
	elif [ "$1" == "-r" ] || [ "$1" == "--restart" ] && [ "$2" == "-c" ] || [ "$2" == "--config" ]; then
		echo "Restart pipeline..."
		restart=true
		params=$1
		config=$3
	else
		echo "Exit program - Invalid parameters: $@" && $BLJ/script/biolockj -h && exit 1 
	fi  
else
    echo "Exit program - Invalid parameters: $@" && $BLJ/script/biolockj -h && exit 1 
fi

$restart && [ ! -d "$config" ] && [ ! -f "$config" ] && echo "Exit program - $config is not a valid directory or file"  && $BLJ/script/biolockj -h && exit 1
! $restart && [ ! -f "$config" ] && echo "Exit program - $config is not a valid file" && $BLJ/script/biolockj -h && exit 1

echo "BioLockJ JAR: $bljJar" 
echo "BioLockJ Config:  $config"

nohup java -jar $bljJar $params -b $BLJ_PROJ -c $config >/dev/null 2>&1 &

[ $? != 0 ] && echo "Exit program - Unable to run $bljJar" && exit 1

echo "Executing command: \"nohup java -jar $bljJar $params -b $BLJ_PROJ -c $config >/dev/null 2>&1 &\""