#!/bin/bash
##########################################################################
##                                                                      ##
##  Script requires 1+ of the listed arguments parameter.               ##
##  Script requires  BioLockJ pipeline root directory: $BLJ_PROJ.       ##
##                                                                      ##
##  Pass optional param "-r" as 1st param to restart failed pipeline    ##
##                                                                      ##
##  Pass admin email password as 1st param to encode and store in the   ##
##  BioLockJ Config file (2nd param) instead of running a pipeline      ##
##                                                                      ##
##########################################################################
. "${AWS_LIB}"

BLJ_JAR=${BLJ}/dist/BioLockJ.jar

# Display BioLockJ release version
display_version() {
	[ -f "${BLJ}/.version" ] && cat "${BLJ}/.version" && return
	echo "Missing ${BLJ}/.version"
}

# Show the help menu
display_help() {
    echo "BioLockJ $(display_version) - UNCC Fodor Lab July 2018" 
    echo 'Most args can be passed using 1st letter only (with or without hyphens)'
    echo '    Run new pipeline:        config   <file_path>'
    echo '    Restart pipeline:        restart  <dir_path>'
    echo '    Encrypt password:        pass     <password>'
    echo '    Show help menu:          help'
    echo '    Show version:            version'
    echo '    Run on AWS:              aws'
    echo '    Run in Docker:           docker'
    echo '    Run Docker GUI:          gui'
    echo '    Mount Docker BLJ         blj'
    echo '    Mount Docker BLJ_SUP     blj_sup'
}

# Get dockblj scripts formatted named arg params
docker_args() {
	args='' && [ ${#gui} -gt 0 ] && args="-gui"
	[ ${#config} -gt 0 ] && args="c=${config}" && [ ${#newPass} -gt 0 ] && args="${args} p=${newPass}"
	[ ${#restart} -gt 0 ] && args="${args} r=${restart}"
	[ ${#blj} -gt 0 ] && args="${args} blj"
	[ ${#blj_sup} -gt 0 ] && args="${args} blj_sup"
	echo "${args}"
}

# Convert input parameters to array with values "name=value"
get_params() {
	count=0 && i=0 && conf='' && restartDir='' && args=( "$@" )
	numArgs=${#args[*]}
    for arg in ${args[@]}; do
    	count=$((count+1))
    	a="${arg//-}"
    	[ $a == blj ] && echo blj && continue
   	 	[ $a == blj_sup ] && echo blj_sup && continue
		i=$((i+1)) && [ $((i%2)) -eq 1 ] && name=$a
		[ $((i%2)) -eq 1 ] && ! $(lastArgMustBeConfig $count $numArgs) && $(is_flag_arg $name) && echo "${name:0:1}" && name='' && i=$((i+1)) && continue
		if [ $((i%2)) -eq 0 ]; then
			echo "${name}=${arg}" && x="${name}" && name=''
			[ "${x:0:1}" == "r" ] && restartDir="${arg}"
			[ "${x:0:1}" == "c" ] && conf="${arg}"
    	fi
    done
     [ ${#name} -gt 0 ] && [ ${#conf} -eq 0 ] && echo "c=${name}"
}

# Determine if given arg is a flag arg that will not be matched with the next arg
# Param 1 - script arg
is_flag_arg() {
	[ $(echo ${1:0:1} | egrep -c 'a|b|d|g') -gt 0 ]
}

# The last arg must be the config path, if config & restart dir are undefined and we are looking at the last parameter
# Param 1 - Current script input param number
# Param 2 - Total number of script input params
lastArgMustBeConfig() {
	[ $1 -eq $2 ] && [ ${#conf} -eq 0 ] && [ ${#restartDir} -eq 0 ]
}

# Initialize script, read in script arguments
# Param 1 -  All script args ${@}
read_input_args() {
	args=$(get_params $@)
	blj=$(arg_exists $args blj)
	blj_sup=$(arg_exists $args blj_sup)
	runAws=$(arg_exists $args a)
	runGui=$(arg_exists $args g)
	displayHelp=$(arg_exists $args h)
	displayVersion=$(arg_exists $args v)
	runDocker=$(arg_exists $args d)
	config=$(named_arg $args c)
	newPass=$(named_arg $args p)
	restart=$(named_arg $args r)
	
	if [ ${#runDocker} -eq 0 ]; then 
		[ ${#runGui} -gt 0 ] && runDocker="d" && echo "Arg \"gui\" is only applicable in Docker mode --> starting Docker biolockj_controller container"
		[ ${#blj} -gt 0 ] && echo "Arg \"blj\" is only applicable in Docker mode so will be ignored"
		[ ${#blj_sup} -gt 0 ] && echo "Arg \"blj_sup\" is only applicable in Docker mode so will be ignored"
	fi
}

# Run biolockj by locally, on AWS, or in Docker mode based on script args
run_biolockj() {
	if [ ${#runAws} -gt 0 ]; then
		if [ ${#gui} -gt 0 ]; then
			run_aws_gui
		else
			run_aws "${config}"
		fi
	elif [ ${#runDocker} -gt 0 ]; then
		dockblj $(docker_args)
	else
		[ ${#config} -gt 0 ] && args="c=${config}" && [ ${#newPass} -gt 0 ] && args="${args} p=${newPass}"
		[ ${#runGui} -eq 0 ] && [ ${#restart} -eq 0 ] && [ ! -f "${config}" ] && 
			${BLJ}/script/biolockj -h && exit_script "Error [ biolockj ]:  \"${config}\" not found on filesystem"
		[ ! -d "${BLJ_PROJ}" ] && exit_script "Error [ biolockj ]: Required env variable BLJ_PROJ undefined: \"${BLJ_PROJ}\""
		[ ! -f "${BLJ_JAR}" ] && exit_script "Error [ biolockj ]: BioLockJ Jar file \"${BLJ_JAR}\" not found"
		start_pipeline "${@}"
	fi
}

# Start local pipeline by calling java to run the BioLockJ.jar on the given Config file
# Param 1 - array of script args "$@"
start_pipeline() {
	i=0 && initDir="$(most_recent_pipeline)" && pipeDir="${initDir}" && initJava=$(ps | grep -c java) 
	numJava=${initJava} && echo -e "Launching BioLockJ:  \"nohup java -jar ${BLJ_JAR} -b ${BLJ_PROJ} -u ${HOME} $@ >/dev/null 2>&1 &\""
	nohup java -jar "${BLJ_JAR}" -b "${BLJ_PROJ}" -u "${HOME}" $@ >/dev/null 2>&1 &
	[ $? != 0 ] && ${BLJ}/script/biolockj -h && exit_script "Error [ biolockj ]:  Unable to run ${BLJ_JAR}"
	printf "Initializing BioLockJ."
	while [ $i -lt 15 ] && [ "${initDir}" == "${pipeDir}" ] && [ ${initJava} -eq ${numJava} ]; do
		sleep 3 && i=$((i+1)) && printf "." && pipeDir="$(most_recent_pipeline)" && numJava=$(ps | grep -c java)
	done
	sleep 1 && echo "." && pipeDir="$(most_recent_pipeline)"
	if [ ${#restart} -gt 0 ] && [ ${numJava} -gt ${initJava} ]; then 
		echo "Restarting pipeline:  ${pipeDir}"
	elif [ ${#restart} -eq 0 ] && [ "${initDir}" != "${pipeDir}" ] || [ ${numJava} -gt ${initJava} ]; then 
		echo "Starting pipeline:  ${pipeDir}"
	elif [ ${#restart} -eq 0 ] && [ ${#runGui} -eq 0 ]; then
		echo "Pipeline may have failed to launch - check $BLJ_PROJ for new pipeline"
	fi
	echo "blj_go       -> Move to pipeline output directory"
	echo "blj_log      -> Tail pipeline log (accepts tail runtime parameters)"
	echo "blj_summary  -> View module execution summary"
}

arg="${@//-}"
if [ $# -eq 1 ] && [ "${arg:0:1}" == "v" ]; then
	display_version
elif [ $# -eq 1 ] && [ "${arg:0:1}" == "h" ]; then
	display_help
else
	printf "\n ---------> Execute CMD [  biolockj $(echo ${@})  ]\n"
	read_input_args "${@}"
	run_biolockj "${@}"
fi