#!/bin/bash
##############################################################################
##                                                                          ##
##  Script launches BioLockJ in a Docker container                          ##
##                                                                          ##
##  Bash env must include pipeline base directory: $BLJ_PROJ                ##
##                                                                          ##
##  Required Parameters                                                     ##
##  Config file path:       config                                          ##
##  Input directories:      inputDirPaths (commma separated, no spaces)     ##
##                                                                          ##
##  Optional parameters:                                                    ##
##                                                                          ##
##  Admin email password    changePassword                                  ##
##  Metadata directory:     metadataFilePath                                ##
##  Primer directory:       trimPrimersFilePath                             ##
##  Restart flag:           -r <directory>                                  ##
##  Docker flag:            -docker                                         ##
##                                                                          ##
##############################################################################
. $BLJ/script/blj_functions

[ ! -d "$BLJ_PROJ" ] && echo "Exit program - Required bash variable BLJ_PROJ undefined" && exit 1

# Pass script input parameters + the argument value
# Return value if found in input parameters
arg_exists() {
	args=("$@")
	numArgs=${#@}
	target=${args[$((numArgs-1))]}
	args=${args[@]:0:$((numArgs-1))}
	for arg in $args;
	do
		[ "$arg" == "$target" ] && echo "$target" && return
	done
}

# Pass script input parameters + the argument name
# Named arguments must be formated: "argName=argValue"
get_named_arg() {
	args=("$@")
	numArgs=${#@}
	target=${args[$((numArgs-1))]}
	args=${args[@]:0:$((numArgs-1))}
	for arg in $args; 
	do
		IFS="="
		tokens=( $arg )
		[ ${#tokens[*]} -eq 2 ] && [ ${tokens[0]} == $target ] && echo ${tokens[1]} && return
	done
}

# Return $HOST_BLJ_PROJ if called from within a docker container (like webapp), otherwise return $BLJ_PROJ
get_blj_proj() {
	
	bljProj=$BLJ_PROJ
	if [ ${#inDockerContainer} -gt 0 ]; then
		bljProj=$HOST_BLJ_PROJ
		if [ ${#HOST_BLJ_PROJ} -gt 0 ]; then
			bljProj=$HOST_BLJ_PROJ
		else
			echo "Exit program - Required env variable HOST_BLJ_PROJ undefined" && exit 1
		fi
	fi
	
	if [ "${bljProj: -1}" == "/" ]; then
		len=$((${#bljProj}-1))
		bljProj="${bljProj:0:len}"
	fi
	
	[ ${#bljProj} -gt 0 ] && echo $bljProj && return
	echo "Exit program - Required env variable BLJ_PROJ undefined" && exit 1
}

# Verify host file exists, if dockblj is not deployed inside a Docker container
validateHostFile() {
	#echo "validate Host Dir: $# + $1"
	[ ${#inDockerContainer} -eq 0 ] && [ $# -eq 2 ] && [ ! -f "$1" ] && echo "Exit script - $2 file not found: $1" && exit 1
}

# Verify host directory exists, if dockblj is not deployed inside a Docker container
validateHostDir() {
	#echo "validate Host Dir: $# + $1"
 	[ ${#inDockerContainer} -eq 0 ] && [ $# -eq 2 ] && [ ! -d "$1" ] && echo "Exit script - $2 directory not found: $1" && exit 1
}

# Verify paths are valid, if dockblj is not deployed inside a Docker container
validate_input() {
	[ ${#restartPipeline} -gt 0 ] && validateHostDir $restartPipeline Restart
	[ ${#restartPipeline} -eq 0 ] && validateHostFile $config Config
	validateHostDir $metadataFilePath Metadata
	validateHostDir $trimPrimersFilePath Primer
	if [ ${#inputDirPaths} -lt 0 ]; then
		echo "Exit script - Input directory is required" && exit 1
	else
		IFS=","
		dirPaths=( $inputDirPaths )
		for dir in "$dirPaths"; do
			validateHostDir $dir Input
		done
	fi 
}

get_restart_dir() {
	echo "/pipelines/${restartPipeline#$(get_blj_proj)/}"
}

# Populates the docker run BLJ_OPTIONS parameter
# Include -D to run BioLockJ in a Docker container
# Include Docker container path to required Config file
# Include all directory paths the blj_manager may need to map volumes in spawned Docker compute node instances
get_blj_options() {
	options="-D -b $(get_blj_proj)" 
	[ ${#config} -gt 0 ] && [ ${#restartPipeline} -gt 0 ] && options="$options -C $(dirname $config) -r $(get_restart_dir) -c /config/$(basename $config)"
	[ ${#config} -gt 0 ] && [ ${#restartPipeline} -eq 0 ] && options="$options -C $(dirname $config) -c /config/$(basename $config)"
	[ ${#changePassword} -gt 0 ] && options="$options -p $changePassword"
	[ ${#inputDirPaths} -gt 0 ] && options="$options -i $inputDirPaths"
	[ ${#metadataFilePath} -gt 0 ] && options="$options -m $metadataFilePath"
	[ ${#trimPrimersFilePath} -gt 0 ] && options="$options -t $trimPrimersFilePath"
	echo $options
}

# Print status message with GUI context and BLJ_OPTIONS
get_status_msg() {
	msg=""
	if [ ${#inDockerContainer} -gt 0 ]; then
		msg="Docker $DOCKER_HUB_USER/webapp GUI"
	else
		msg="Host machine $BLJ/web_app GUI" 
	fi
	
	if [ ${#restartPipeline} -gt 0 ]; then
		msg+=" restarting $(get_restart_dir) in $DOCKER_HUB_USER/blj_manager Docker container"
	else
		msg+=" starting $DOCKER_HUB_USER/blj_manager Docker container"
	fi
	
	echo "$msg with BLJ_OPTIONS=$(get_blj_options)"
}

config=$(get_named_arg "$@" "config")
inputDirPaths=$(get_named_arg "$@" "inputDirPaths")
metadataFilePath=$(get_named_arg "$@" "metadataFilePath")
trimPrimersFilePath=$(get_named_arg "$@" "trimPrimersFilePath")
changePassword=$(get_named_arg "$@" "-p")
restartPipeline=$(get_named_arg "$@" "-r")
inDockerContainer=$(arg_exists "$@" "-docker")

# Call function to verify input parameters are vaild
validate_input

# Call function to print status message
echo $(get_status_msg)

#echo "config: $(dirname $config)"
#echo "inputDir: $inputDirPaths"
#echo "metadataFilePath: $metadataFilePath"
#echo "BLJ_PROJ: $(get_blj_proj)"
#echo "BLJ_OPTIONS: $(get_blj_options)"

if [ ${#metadataFilePath} -gt 0 ] && [ ${#trimPrimersFilePath} -gt 0 ]; then
	docker run -e "BLJ_OPTIONS=$(get_blj_options)" -v /var/run/docker.sock:/var/run/docker.sock \
		-v $(get_blj_proj):/pipelines:delegated -v $(dirname $config):/config -v $inputDirPaths:/input \
		-v $metadataFilePath:/meta -v $trimPrimersFilePath:/primer \
		--rm $DOCKER_HUB_USER/blj_manager
elif [ ${#metadataFilePath} -gt 0 ]; then	
	docker run -e "BLJ_OPTIONS=$(get_blj_options)" -v /var/run/docker.sock:/var/run/docker.sock \
		-v $(get_blj_proj):/pipelines:delegated -v $(dirname $config):/config -v $inputDirPaths:/input \
		-v $metadataFilePath:/meta \
		--rm $DOCKER_HUB_USER/blj_manager
elif [ ${#trimPrimersFilePath} -gt 0 ]; then	
	docker run -e "BLJ_OPTIONS=$(get_blj_options)" -v /var/run/docker.sock:/var/run/docker.sock \
		-v $(get_blj_proj):/pipelines:delegated -v $(dirname $config):/config -v $inputDirPaths:/input \
		-v $trimPrimersFilePath:/primer \
		--rm $DOCKER_HUB_USER/blj_manager 
else
	docker run -e "BLJ_OPTIONS=$(get_blj_options)" -v /var/run/docker.sock:/var/run/docker.sock \
		-v $(get_blj_proj):/pipelines:delegated -v $(dirname $config):/config -v $inputDirPaths:/input \
		--rm $DOCKER_HUB_USER/blj_manager 
fi

[ $? -ne 0 ] && echo "Exit script - docker run command failed"  
